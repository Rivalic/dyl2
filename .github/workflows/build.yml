name: Build Swiggy IPA with Device Rotation

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Setup Theos
      run: |
        echo "Setting up Theos..."
        export THEOS=~/theos
        if [ ! -d "$THEOS" ]; then
          git clone --recursive https://github.com/theos/theos.git $THEOS
        fi
        echo "THEOS=$THEOS" >> $GITHUB_ENV
    
    - name: Install dependencies
      run: |
        echo "Installing dependencies..."
        brew install ldid
        
        # Install insert_dylib
        if ! command -v insert_dylib &> /dev/null; then
          git clone https://github.com/Tyilo/insert_dylib.git /tmp/insert_dylib
          cd /tmp/insert_dylib
          xcodebuild
          sudo cp build/Release/insert_dylib /usr/local/bin/
        fi
    
    - name: Build DeviceRotation dylib
      run: |
        echo "Building DeviceRotation.dylib..."
        cd DeviceRotation
        export THEOS=~/theos
        make clean
        make package
        
        # Copy dylib to Frameworks
        mkdir -p ../swiggy-extracted/Frameworks
        cp .theos/obj/debug/DeviceRotation.dylib ../swiggy-extracted/Frameworks/
        
        echo "Dylib built successfully!"
        ls -lh .theos/obj/debug/DeviceRotation.dylib
    
    - name: Inject dylib into app
      run: |
        echo "Injecting dylib into Swiggy binary..."
        
        BINARY="swiggy-extracted/swiggy"
        DYLIB_PATH="@executable_path/Frameworks/DeviceRotation.dylib"
        
        # Backup original
        cp "$BINARY" "${BINARY}.backup"
        
        # Inject using insert_dylib
        insert_dylib --inplace --all-yes "$DYLIB_PATH" "$BINARY"
        
        echo "Dylib injected successfully!"
    
    - name: Re-sign app
      run: |
        echo "Re-signing app with ldid..."
        ldid -S swiggy-extracted/swiggy
        ldid -S swiggy-extracted/Frameworks/DeviceRotation.dylib
        echo "App re-signed!"
    
    - name: Build IPA
      run: |
        echo "Building IPA..."
        python3 build_ipa.py
        
        echo "IPA built successfully!"
        ls -lh Swiggy-DeviceRotation.ipa
    
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v3
      with:
        name: Swiggy-DeviceRotation-IPA
        path: Swiggy-DeviceRotation.ipa
        retention-days: 30
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: Swiggy-DeviceRotation.ipa
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
