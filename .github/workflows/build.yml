name: Build Swiggy IPA with Device Rotation

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Theos
      run: |
        echo "Setting up Theos..."
        export THEOS=~/theos
        if [ ! -d "$THEOS" ]; then
          git clone --recursive https://github.com/theos/theos.git $THEOS
        fi
        echo "THEOS=$THEOS" >> $GITHUB_ENV
    
    - name: Install dependencies
      run: |
        echo "Installing dependencies..."
        brew install ldid
        
        # Install insert_dylib
        echo "Building insert_dylib..."
        git clone https://github.com/Tyilo/insert_dylib.git /tmp/insert_dylib
        cd /tmp/insert_dylib
        # The main file is insert_dylib.c, not main.c
        if [ -f "insert_dylib.c" ]; then
          clang -O3 insert_dylib.c -o insert_dylib
          sudo cp insert_dylib /usr/local/bin/
          chmod +x /usr/local/bin/insert_dylib
          echo "Successfully installed insert_dylib"
        else
          echo "Listing files to find main file..."
          ls -R
          xcodebuild -configuration Release
          find . -name insert_dylib -type f -exec sudo cp {} /usr/local/bin/ \;
        fi
        
        # Install optool as fallback
        echo "Building optool..."
        git clone --recursive https://github.com/alexzielenski/optool.git /tmp/optool
        cd /tmp/optool
        xcodebuild -configuration Release
        if [ -f "build/Release/optool" ]; then
          sudo cp build/Release/optool /usr/local/bin/
          echo "Successfully installed optool"
        fi
        
        # Verify tools
        command -v insert_dylib || echo "insert_dylib not found"
        command -v optool || echo "optool not found"
    
    - name: Build DeviceRotation dylib
      run: |
        echo "Building DeviceRotation.dylib..."
        cd DeviceRotation
        export THEOS=~/theos
        # Ensure SDK is found
        make clean
        make
        
        # Find the dylib (Theos might put it in different places)
        DYLIB_FILE=$(find . -name "DeviceRotation.dylib" -type f | head -n 1)
        if [ -f "$DYLIB_FILE" ]; then
          echo "Found dylib at $DYLIB_FILE"
          mkdir -p ../swiggy-extracted/Frameworks
          cp "$DYLIB_FILE" ../swiggy-extracted/Frameworks/
        else
          echo "Error: DeviceRotation.dylib not found!"
          ls -R .
          exit 1
        fi
        
        echo "Dylib built successfully!"
        ls -lh ../swiggy-extracted/Frameworks/DeviceRotation.dylib
    
    - name: Inject dylib into app
      run: |
        echo "Injecting dylib into Swiggy binary..."
        
        BINARY="swiggy-extracted/swiggy"
        DYLIB_PATH="@executable_path/Frameworks/DeviceRotation.dylib"
        
        # Check if binary exists
        if [ ! -f "$BINARY" ]; then
          echo "Error: Binary not found at $BINARY"
          exit 1
        fi
        
        # Backup original
        cp "$BINARY" "${BINARY}.backup"
        
        # Try insert_dylib first
        if command -v insert_dylib &> /dev/null; then
          echo "Using insert_dylib..."
          insert_dylib --inplace --all-yes "$DYLIB_PATH" "$BINARY"
        elif command -v optool &> /dev/null; then
          echo "Using optool..."
          optool install -c load -p "$DYLIB_PATH" -t "$BINARY"
        else
          echo "Error: No injection tool found!"
          exit 1
        fi
        
        # Verify injection
        otool -L "$BINARY" | grep DeviceRotation || true
        
        echo "Dylib injected successfully!"
    
    - name: Re-sign app
      run: |
        echo "Re-signing app with ldid..."
        ldid -S swiggy-extracted/swiggy
        ldid -S swiggy-extracted/Frameworks/DeviceRotation.dylib
        echo "App re-signed!"
    
    - name: Build IPA
      run: |
        echo "Building IPA..."
        python3 build_ipa.py
        
        echo "IPA built successfully!"
        ls -lh Swiggy-DeviceRotation.ipa
    
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: Swiggy-DeviceRotation-IPA
        path: Swiggy-DeviceRotation.ipa
        retention-days: 30
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: Swiggy-DeviceRotation.ipa
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
