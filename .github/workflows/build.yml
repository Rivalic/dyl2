name: Build Swiggy IPA with Device Rotation

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Theos
      run: |
        echo "Setting up Theos..."
        export THEOS=~/theos
        if [ ! -d "$THEOS" ]; then
          git clone --recursive https://github.com/theos/theos.git $THEOS
        fi
        echo "THEOS=$THEOS" >> $GITHUB_ENV
    
    - name: Install dependencies
      run: |
        echo "Installing dependencies..."
        brew install ldid
        
        # Install insert_dylib
        echo "Building insert_dylib..."
        git clone https://github.com/Tyilo/insert_dylib.git /tmp/insert_dylib
        cd /tmp/insert_dylib
        # Use clang directly for a more reliable build
        clang -O3 main.c -o insert_dylib
        
        if [ -f "insert_dylib" ]; then
          echo "Successfully built insert_dylib"
          sudo cp insert_dylib /usr/local/bin/
          chmod +x /usr/local/bin/insert_dylib
        else
          echo "Error: Failed to build insert_dylib!"
          ls -R .
          exit 1
        fi
        
        # Verify installation
        command -v insert_dylib
        insert_dylib --version || true
    
    - name: Build DeviceRotation dylib
      run: |
        echo "Building DeviceRotation.dylib..."
        cd DeviceRotation
        export THEOS=~/theos
        make clean
        make package
        
        # Verify build output
        ls -R .theos/obj
        
        # Copy dylib to Frameworks
        mkdir -p ../swiggy-extracted/Frameworks
        cp .theos/obj/debug/DeviceRotation.dylib ../swiggy-extracted/Frameworks/ || cp .theos/obj/DeviceRotation.dylib ../swiggy-extracted/Frameworks/
        
        echo "Dylib built successfully!"
        ls -lh ../swiggy-extracted/Frameworks/DeviceRotation.dylib
    
    - name: Inject dylib into app
      run: |
        echo "Injecting dylib into Swiggy binary..."
        
        BINARY="swiggy-extracted/swiggy"
        DYLIB_PATH="@executable_path/Frameworks/DeviceRotation.dylib"
        
        # Check if binary exists
        if [ ! -f "$BINARY" ]; then
          echo "Error: Binary not found at $BINARY"
          ls -R swiggy-extracted/
          exit 1
        fi
        
        # Backup original
        cp "$BINARY" "${BINARY}.backup"
        
        # Inject using insert_dylib
        insert_dylib --inplace --all-yes "$DYLIB_PATH" "$BINARY"
        
        # Verify injection
        otool -L "$BINARY" | grep DeviceRotation
        
        echo "Dylib injected successfully!"
    
    - name: Re-sign app
      run: |
        echo "Re-signing app with ldid..."
        ldid -S swiggy-extracted/swiggy
        ldid -S swiggy-extracted/Frameworks/DeviceRotation.dylib
        echo "App re-signed!"
    
    - name: Build IPA
      run: |
        echo "Building IPA..."
        python3 build_ipa.py
        
        echo "IPA built successfully!"
        ls -lh Swiggy-DeviceRotation.ipa
    
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: Swiggy-DeviceRotation-IPA
        path: Swiggy-DeviceRotation.ipa
        retention-days: 30
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: Swiggy-DeviceRotation.ipa
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
